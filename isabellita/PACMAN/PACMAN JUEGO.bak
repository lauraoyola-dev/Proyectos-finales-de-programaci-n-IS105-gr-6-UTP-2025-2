#lang racket
(require 2htdp/universe 2htdp/image)

;; -----------------------
;; Imágenes (asegúrate de tener los archivos en la misma carpeta)
;; -----------------------
(define FONDO      (bitmap "fondo.png"))
(define PACMAN     (list (bitmap "pac1.png") (bitmap "pac2.png") (bitmap "pac3.png") (bitmap "pac2.png")))
(define PINK-GHOST (list (bitmap "ghost1.png") (bitmap "ghost2.png")))
(define MENU1      (bitmap "menu1.png"))
(define MENU-GHOST (bitmap "menughost.png"))
(define NIVEL1     (bitmap "nivel1.png"))
(define OBSTACULO1 (bitmap "triangulo.png"))
(define REINTENTAR (bitmap "reintentar.png"))
(define NEXT       (bitmap "next.png"))
(define MENU2      (bitmap "menu2.png"))
(define NIVEL2     (bitmap "nivel2.png"))
(define PUERTA     (bitmap "puerta.png"))
(define MENU3      (bitmap "menu3.png"))

;mundo
(struct world (estado pac ghost menu-ghost-x menu-ghost-y
                    pac-x pac-y ghost-x ghost-y
                    jumping jump-t last-dx
                    obst1-x obst1-y
                    obst2-x obst2-y
                   ) #:transparent)

(define initial-world
  (world "inicio"
         0 0 0 575            
         150 600 850 600      
         #f 0 0               
         700 700               
         700 700))    

;click
(define (click-en-start? x y)
  (and (>= x 290) (<= x 646)
       (>= y 360) (<= y 478)))

(define (click-en-nivel1? x y)
  (and (>= x 155) (<= x 340)
       (>= y 216) (<= y 430)))

;colision
(define (colision-obstaculo? x y ox oy)
  (and (>= x (- ox 40)) (<= x (+ ox 40))
       (>= y (- oy 50)) (<= y (+ 10 oy))))


(define (colision-con-lista? w new-x new-y obst-list)
  (let ([margin-altura 40])
    (ormap (lambda (obs)
             (let ([ox (car obs)]
                   [oy (cdr obs)])
               (and (colision-obstaculo? new-x new-y ox oy)
                    (>= new-y (- oy margin-altura))
                    (not (world-jumping w)))))
           obst-list)))

;obstaculos
(define (dibujar-obstaculos w base-image)
  (let* ([y-offset (if (string=? (world-estado w) "nivel2") -15 0)]
         [img1 (place-image OBSTACULO1 (world-obst1-x w) (+ (world-obst1-y w) y-offset) base-image)]
         [img2 (if (string=? (world-estado w) "nivel2")
                   (place-image OBSTACULO1 (world-obst2-x w) (+ (world-obst2-y w) y-offset) img1)
                   img1)])
    img2))

(define (obstaculos-activos w)
  (cond
    [(string=? (world-estado w) "nivel1")
     (list (cons (world-obst1-x w) (world-obst1-y w)))]
    [(string=? (world-estado w) "nivel2")
     (list (cons (world-obst1-x w) (world-obst1-y w))
           (cons (world-obst2-x w) (world-obst2-y w)))]
    [else '()]))


(define (dibujar-nivel w)
  (let* ([base (if (string=? (world-estado w) "nivel2") NIVEL2 NIVEL1)]
         [with-obst (dibujar-obstaculos w base)]
         [char-y-offset (if (string=? (world-estado w) "nivel2") -10 0)]
         [ghost-img (list-ref PINK-GHOST (world-ghost w))]
         [pac-img (list-ref PACMAN (world-pac w))]
         [ghost-y (+ (world-ghost-y w) char-y-offset)]
         [pac-y (+ (world-pac-y w) char-y-offset)])
    (place-image pac-img (world-pac-x w) pac-y
      (place-image ghost-img (world-ghost-x w) ghost-y with-obst))))

;tick
(define (tick w)
  (cond
    [(string=? (world-estado w) "inicio")
     (world "inicio"
            (modulo (+ 1 (world-pac w)) (length PACMAN))
            (modulo (+ 1 (world-ghost w)) (length PINK-GHOST))
            (world-menu-ghost-x w) (world-menu-ghost-y w)
            (world-pac-x w) (world-pac-y w)
            (world-ghost-x w) (world-ghost-y w)
            (world-jumping w)
            (world-jump-t w)
            (world-last-dx w)
            (world-obst1-x w) (world-obst1-y w)
            (world-obst2-x w) (world-obst2-y w))]
    [(string=? (world-estado w) "menu1")
     (let* ([temp-x (+ (world-menu-ghost-x w) 15)]
            [new-x (if (> temp-x 800) 0 temp-x)])
       (world "menu1"
              (modulo (+ 1 (world-pac w)) (length PACMAN))
              (modulo (+ 1 (world-ghost w)) (length PINK-GHOST))
              new-x (world-menu-ghost-y w)
              (world-pac-x w) (world-pac-y w)
              (world-ghost-x w) (world-ghost-y w)
              (world-jumping w) (world-jump-t w) (world-last-dx w)
              (world-obst1-x w) (world-obst1-y w)
              (world-obst2-x w) (world-obst2-y w)))]
    [(string=? (world-estado w) "menu2")
     (let* ([temp-x (+ (world-menu-ghost-x w) 15)]
            [new-x (if (> temp-x 800) 0 temp-x)])
       (world "menu2"
              (modulo (+ 1 (world-pac w)) (length PACMAN))
              (modulo (+ 1 (world-ghost w)) (length PINK-GHOST))
              new-x (world-menu-ghost-y w)
              (world-pac-x w) (world-pac-y w)
              (world-ghost-x w) (world-ghost-y w)
              (world-jumping w) (world-jump-t w) (world-last-dx w)
              (world-obst1-x w) (world-obst1-y w)
              (world-obst2-x w) (world-obst2-y w)))]
  [(or (string=? (world-estado w) "nivel1")
     (string=? (world-estado w) "nivel2"))
 (let* ([jumping? (world-jumping w)]
        [t (world-jump-t w)]
        [jump-duration 9]
        [jump-height 80]
        [ground-y 600]
        [dx (world-last-dx w)]
        [new-t (if jumping? (+ t 1) t)]
        [r (/ (exact->inexact new-t) jump-duration)]
        [new-y (if jumping?
                   (- ground-y (* 4 jump-height r (- 1 r)))
                   ground-y)]
        [still-jumping? (and jumping? (< new-t jump-duration))]
        [final-t (if still-jumping? new-t 0)]
        [new-dx (if still-jumping? dx 0)]
        [new-pac-x (if jumping?
               (+ (world-pac-x w) (* 2 (world-last-dx w))) ; avanza el doble
               (world-pac-x w))]
[new-ghost-x (+ new-pac-x -100)]
        [obst-list (obstaculos-activos w)]
        [pac-coll? (colision-con-lista? w new-pac-x new-y obst-list)]
        [ghost-coll? (colision-con-lista? w new-ghost-x new-y obst-list)])
   
   (cond
     [pac-coll?
      (world "reintentar"
             (world-pac w) (world-ghost w)
             (world-menu-ghost-x w) (world-menu-ghost-y w)
             new-pac-x ground-y
             new-ghost-x ground-y
             #f 0 new-dx
             (world-obst1-x w) (world-obst1-y w)
             (world-obst2-x w) (world-obst2-y w))]

     [ghost-coll?
      (world "next"
             (world-pac w) (world-ghost w)
             (world-menu-ghost-x w) (world-menu-ghost-y w)
             new-pac-x new-y
             new-ghost-x new-y
             still-jumping? final-t new-dx
             (world-obst1-x w) (world-obst1-y w)
             (world-obst2-x w) (world-obst2-y w))]

     [else
      (world (world-estado w)
             (modulo (+ 1 (world-pac w)) (length PACMAN))
             (modulo (+ 1 (world-ghost w)) (length PINK-GHOST))
             (world-menu-ghost-x w) (world-menu-ghost-y w)
             new-pac-x new-y
             new-ghost-x new-y
             still-jumping? final-t new-dx
             (world-obst1-x w) (world-obst1-y w)
             (world-obst2-x w) (world-obst2-y w))]))]

    [else w]))

;mouse
(define (mouse-handler w x y event)
  (cond
    [(and (string=? (world-estado w) "inicio")
          (string=? event "button-down")
          (click-en-start? x y))
     (world "menu1"
            (world-pac w) (world-ghost w)
            0 575
            (world-pac-x w) (world-pac-y w)
            (world-ghost-x w) (world-ghost-y w)
            (world-jumping w) (world-jump-t w) (world-last-dx w)
            (world-obst1-x w) (world-obst1-y w)
            (world-obst2-x w) (world-obst2-y w))]
    [(and (string=? (world-estado w) "menu1")
          (string=? event "button-down")
          (click-en-nivel1? x y))
     (world "nivel1"
            0 0
            (world-menu-ghost-x w) (world-menu-ghost-y w)
            200 600 100 600
            #f 0 0
            400 600  
            2000 2000)] 
    [(and (string=? (world-estado w) "reintentar")
          (string=? event "button-down"))
     (if (< (world-obst2-x w) 2000)
         (world "nivel2"
                0 0
                (world-menu-ghost-x w) (world-menu-ghost-y w)
                150 600 850 600
                #f 0 0
                (world-obst1-x w) (world-obst1-y w)
                (world-obst2-x w) (world-obst2-y w))
         (world "nivel1"
                0 0
                0 575
                150 600 850 600
                #f 0 0
                400 600
                2000 2000))]

    [(and (string=? (world-estado w) "next")
          (string=? event "button-down"))
     (if (< (world-obst2-x w) 2000)
         (world "menu3"
                (world-pac w) (world-ghost w)
                (world-menu-ghost-x w) (world-menu-ghost-y w)
                (world-pac-x w) (world-pac-y w)
                (world-ghost-x w) (world-ghost-y w)
                (world-jumping w) (world-jump-t w) (world-last-dx w)
                (world-obst1-x w) (world-obst1-y w)
                (world-obst2-x w) (world-obst2-y w))
         (world "menu2"
                (world-pac w) (world-ghost w)
                (world-menu-ghost-x w) (world-menu-ghost-y w)
                (world-pac-x w) (world-pac-y w)
                (world-ghost-x w) (world-ghost-y w)
                (world-jumping w) (world-jump-t w) (world-last-dx w)
                (world-obst1-x w) (world-obst1-y w)
                (world-obst2-x w) (world-obst2-y w)))]

    [(and (string=? (world-estado w) "menu2")
          (string=? event "button-down"))
     (world "nivel2"
            0 0
            (world-menu-ghost-x w) (world-menu-ghost-y w)
            150 600 850 600
            #f 0 0
            300 600 
            600 600)] 
    [(and (string=? (world-estado w) "menu3")
          (string=? event "button-down"))
     (world "nivel2"
            0 0
            (world-menu-ghost-x w) (world-menu-ghost-y w)
            150 600 850 600
            #f 0 0
            300 600
            600 600)]

    [else w]))

;draw

(define (draw w)
  (cond
    [(string=? (world-estado w) "inicio")
     (place-image (list-ref PACMAN (world-pac w)) 100 600
       (place-image (list-ref PINK-GHOST (world-ghost w)) 850 600
         FONDO))]
    [(string=? (world-estado w) "menu1")
     (place-image MENU-GHOST (world-menu-ghost-x w) (world-menu-ghost-y w) MENU1)]
    [(string=? (world-estado w) "menu2")
     (place-image MENU-GHOST (world-menu-ghost-x w) (world-menu-ghost-y w) MENU2)]
    [(string=? (world-estado w) "menu3")
     (place-image MENU-GHOST (world-menu-ghost-x w) (world-menu-ghost-y w) MENU3)]
    [(or (string=? (world-estado w) "nivel1")
         (string=? (world-estado w) "nivel2"))
     (dibujar-nivel w)]
    [(string=? (world-estado w) "reintentar")
     REINTENTAR]
    [(string=? (world-estado w) "next")
     NEXT]
    [else FONDO]))

;teclado
(define (key-handler w key)
  (if (or (string=? (world-estado w) "nivel1")
          (string=? (world-estado w) "nivel2"))
      (cond
        [(string=? key "right")
         (let* ([new-pac-x (+ (world-pac-x w) 5)]
                [new-ghost-x (+ new-pac-x -100)]
                [obst-list (obstaculos-activos w)])
           (if (colision-con-lista? w new-pac-x (world-pac-y w) obst-list)
               w
               (world (world-estado w)
                      (world-pac w) (world-ghost w)
                      (world-menu-ghost-x w) (world-menu-ghost-y w)
                      new-pac-x (world-pac-y w)
                      new-ghost-x (world-ghost-y w)
                      (world-jumping w)
                      (world-jump-t w)
                      8
                      (world-obst1-x w) (world-obst1-y w)
                      (world-obst2-x w) (world-obst2-y w))))]

        [(string=? key "left")
         (let* ([new-pac-x (- (world-pac-x w) 5)]
                [new-ghost-x (+ new-pac-x -100)]
                [obst-list (obstaculos-activos w)])
           (if (colision-con-lista? w new-pac-x (world-pac-y w) obst-list)
               w
               (world (world-estado w)
                      (world-pac w) (world-ghost w)
                      (world-menu-ghost-x w) (world-menu-ghost-y w)
                      new-pac-x (world-pac-y w)
                      new-ghost-x (world-ghost-y w)
                      (world-jumping w)
                      (world-jump-t w)
                      -12
                      (world-obst1-x w) (world-obst1-y w)
                      (world-obst2-x w) (world-obst2-y w))))]

        [(string=? key "up")
         (if (not (world-jumping w))
             (world (world-estado w)
                    (world-pac w) (world-ghost w)
                    (world-menu-ghost-x w) (world-menu-ghost-y w)
                    (world-pac-x w) (world-pac-y w)
                    (world-ghost-x w) (world-ghost-y w)
                    #t
                    0
                    (world-last-dx w)
       
                    (world-obst1-x w) (world-obst1-y w)
                    (world-obst2-x w) (world-obst2-y w))
             w)]
[else w])
      w))

        
;bigbag
(big-bang initial-world
  [to-draw draw]
  [on-tick tick 0.2]
  [on-mouse mouse-handler]
  [on-key key-handler]
  [stop-when (lambda (w) #f)])